package calculations

import (
	"errors"
	"sort"

	"github.com/shopspring/decimal"
)

// Threshold represents a critical value for a given sample size.
type Threshold struct {
	Total          int
	CriticalMisses int
}

// Maximum n value in tables. For n > maxTableN, use simple threshold.
const maxTableN = 990

// Critical value tables generated using normal approximation with alpha=0.05.
var criticalValueTableP005 = []Threshold{
	{2, 2},
	{3, 3},
	{4, 4},
	{5, 4},
	{6, 4},
	{7, 4},
	{8, 4},
	{9, 4},
	{10, 4},
	{20, 4},
	{30, 4},
	{40, 4},
	{50, 5},
	{60, 5},
	{70, 6},
	{80, 7},
	{90, 7},
	{100, 8},
	{110, 9},
	{120, 9},
	{130, 10},
	{140, 11},
	{150, 11},
	{160, 12},
	{170, 13},
	{180, 13},
	{190, 14},
	{200, 15},
	{210, 15},
	{220, 16},
	{230, 16},
	{240, 17},
	{250, 18},
	{260, 18},
	{270, 19},
	{280, 19},
	{290, 20},
	{300, 21},
	{310, 21},
	{320, 22},
	{330, 23},
	{340, 23},
	{350, 24},
	{360, 24},
	{370, 25},
	{380, 25},
	{390, 26},
	{400, 27},
	{410, 27},
	{420, 28},
	{430, 28},
	{440, 29},
	{450, 30},
	{460, 30},
	{470, 31},
	{480, 31},
	{490, 32},
	{500, 33},
	{510, 33},
	{520, 34},
	{530, 34},
	{540, 35},
	{550, 35},
	{560, 36},
	{570, 37},
	{580, 37},
	{590, 38},
	{600, 38},
	{610, 39},
	{620, 39},
	{630, 40},
	{640, 41},
	{650, 41},
	{660, 42},
	{670, 42},
	{680, 43},
	{690, 43},
	{700, 44},
	{710, 45},
	{720, 45},
	{730, 46},
	{740, 46},
	{750, 47},
	{760, 47},
	{770, 48},
	{780, 49},
	{790, 49},
	{800, 50},
	{810, 50},
	{820, 51},
	{830, 51},
	{840, 52},
	{850, 52},
	{860, 53},
	{870, 54},
	{880, 54},
	{890, 55},
	{900, 55},
	{910, 56},
	{920, 56},
	{930, 57},
	{940, 57},
	{950, 58},
	{960, 59},
	{970, 59},
	{980, 60},
	{990, 60},
}

var criticalValueTableP010 = []Threshold{
	{2, 0},
	{3, 1},
	{4, 1},
	{5, 1},
	{6, 1},
	{7, 2},
	{8, 2},
	{9, 2},
	{10, 2},
	{20, 4},
	{30, 5},
	{40, 7},
	{50, 8},
	{60, 9},
	{70, 11},
	{80, 12},
	{90, 13},
	{100, 14},
	{110, 16},
	{120, 17},
	{130, 18},
	{140, 19},
	{150, 21},
	{160, 22},
	{170, 23},
	{180, 24},
	{190, 25},
	{200, 26},
	{210, 28},
	{220, 29},
	{230, 30},
	{240, 31},
	{250, 32},
	{260, 33},
	{270, 35},
	{280, 36},
	{290, 37},
	{300, 38},
	{310, 39},
	{320, 40},
	{330, 41},
	{340, 43},
	{350, 44},
	{360, 45},
	{370, 46},
	{380, 47},
	{390, 48},
	{400, 49},
	{410, 50},
	{420, 52},
	{430, 53},
	{440, 54},
	{450, 55},
	{460, 56},
	{470, 57},
	{480, 58},
	{490, 59},
	{500, 61},
	{510, 62},
	{520, 63},
	{530, 64},
	{540, 65},
	{550, 66},
	{560, 67},
	{570, 68},
	{580, 69},
	{590, 70},
	{600, 72},
	{610, 73},
	{620, 74},
	{630, 75},
	{640, 76},
	{650, 77},
	{660, 78},
	{670, 79},
	{680, 80},
	{690, 81},
	{700, 83},
	{710, 84},
	{720, 85},
	{730, 86},
	{740, 87},
	{750, 88},
	{760, 89},
	{770, 90},
	{780, 91},
	{790, 92},
	{800, 93},
	{810, 95},
	{820, 96},
	{830, 97},
	{840, 98},
	{850, 99},
	{860, 100},
	{870, 101},
	{880, 102},
	{890, 103},
	{900, 104},
	{910, 105},
	{920, 106},
	{930, 108},
	{940, 109},
	{950, 110},
	{960, 111},
	{970, 112},
	{980, 113},
	{990, 114},
}

// For n < 5: no penalty (CriticalMisses = n) due to insufficient statistical power.
var criticalValueTableP020 = []Threshold{
	{2, 2},
	{3, 3},
	{4, 4},
	{5, 4},
	{6, 4},
	{7, 4},
	{8, 4},
	{9, 4},
	{10, 4},
	{20, 6},
	{30, 9},
	{40, 12},
	{50, 14},
	{60, 17},
	{70, 19},
	{80, 21},
	{90, 24},
	{100, 26},
	{110, 28},
	{120, 31},
	{130, 33},
	{140, 35},
	{150, 38},
	{160, 40},
	{170, 42},
	{180, 44},
	{190, 47},
	{200, 49},
	{210, 51},
	{220, 53},
	{230, 55},
	{240, 58},
	{250, 60},
	{260, 62},
	{270, 64},
	{280, 67},
	{290, 69},
	{300, 71},
	{310, 73},
	{320, 75},
	{330, 77},
	{340, 80},
	{350, 82},
	{360, 84},
	{370, 86},
	{380, 88},
	{390, 90},
	{400, 93},
	{410, 95},
	{420, 97},
	{430, 99},
	{440, 101},
	{450, 103},
	{460, 106},
	{470, 108},
	{480, 110},
	{490, 112},
	{500, 114},
	{510, 116},
	{520, 119},
	{530, 121},
	{540, 123},
	{550, 125},
	{560, 127},
	{570, 129},
	{580, 131},
	{590, 133},
	{600, 136},
	{610, 138},
	{620, 140},
	{630, 142},
	{640, 144},
	{650, 146},
	{660, 148},
	{670, 151},
	{680, 153},
	{690, 155},
	{700, 157},
	{710, 159},
	{720, 161},
	{730, 163},
	{740, 165},
	{750, 168},
	{760, 170},
	{770, 172},
	{780, 174},
	{790, 176},
	{800, 178},
	{810, 180},
	{820, 182},
	{830, 184},
	{840, 187},
	{850, 189},
	{860, 191},
	{870, 193},
	{880, 195},
	{890, 197},
	{900, 199},
	{910, 201},
	{920, 203},
	{930, 206},
	{940, 208},
	{950, 210},
	{960, 212},
	{970, 214},
	{980, 216},
	{990, 218},
}

// For n < 5: no penalty (CriticalMisses = n) due to insufficient statistical power.
var criticalValueTableP030 = []Threshold{
	{2, 2},
	{3, 3},
	{4, 4},
	{5, 4},
	{6, 4},
	{7, 4},
	{8, 4},
	{9, 4},
	{10, 5},
	{20, 9},
	{30, 13},
	{40, 16},
	{50, 20},
	{60, 23},
	{70, 27},
	{80, 30},
	{90, 34},
	{100, 37},
	{110, 40},
	{120, 44},
	{130, 47},
	{140, 50},
	{150, 54},
	{160, 57},
	{170, 60},
	{180, 64},
	{190, 67},
	{200, 70},
	{210, 73},
	{220, 77},
	{230, 80},
	{240, 83},
	{250, 86},
	{260, 90},
	{270, 93},
	{280, 96},
	{290, 99},
	{300, 103},
	{310, 106},
	{320, 109},
	{330, 112},
	{340, 115},
	{350, 119},
	{360, 122},
	{370, 125},
	{380, 128},
	{390, 131},
	{400, 135},
	{410, 138},
	{420, 141},
	{430, 144},
	{440, 147},
	{450, 150},
	{460, 154},
	{470, 157},
	{480, 160},
	{490, 163},
	{500, 166},
	{510, 170},
	{520, 173},
	{530, 176},
	{540, 179},
	{550, 182},
	{560, 185},
	{570, 188},
	{580, 192},
	{590, 195},
	{600, 198},
	{610, 201},
	{620, 204},
	{630, 207},
	{640, 211},
	{650, 214},
	{660, 217},
	{670, 220},
	{680, 223},
	{690, 226},
	{700, 229},
	{710, 233},
	{720, 236},
	{730, 239},
	{740, 242},
	{750, 245},
	{760, 248},
	{770, 251},
	{780, 255},
	{790, 258},
	{800, 261},
	{810, 264},
	{820, 267},
	{830, 270},
	{840, 273},
	{850, 276},
	{860, 280},
	{870, 283},
	{880, 286},
	{890, 289},
	{900, 292},
	{910, 295},
	{920, 298},
	{930, 301},
	{940, 305},
	{950, 308},
	{960, 311},
	{970, 314},
	{980, 317},
	{990, 320},
}

// For n < 5: no penalty (CriticalMisses = n) due to insufficient statistical power.
var criticalValueTableP040 = []Threshold{
	{2, 2},
	{3, 3},
	{4, 4},
	{5, 4},
	{6, 4},
	{7, 4},
	{8, 5},
	{9, 6},
	{10, 6},
	{20, 11},
	{30, 16},
	{40, 21},
	{50, 25},
	{60, 30},
	{70, 34},
	{80, 39},
	{90, 43},
	{100, 48},
	{110, 52},
	{120, 56},
	{130, 61},
	{140, 65},
	{150, 69},
	{160, 74},
	{170, 78},
	{180, 82},
	{190, 87},
	{200, 91},
	{210, 95},
	{220, 99},
	{230, 104},
	{240, 108},
	{250, 112},
	{260, 116},
	{270, 121},
	{280, 125},
	{290, 129},
	{300, 133},
	{310, 138},
	{320, 142},
	{330, 146},
	{340, 150},
	{350, 155},
	{360, 159},
	{370, 163},
	{380, 167},
	{390, 171},
	{400, 176},
	{410, 180},
	{420, 184},
	{430, 188},
	{440, 192},
	{450, 197},
	{460, 201},
	{470, 205},
	{480, 209},
	{490, 213},
	{500, 218},
	{510, 222},
	{520, 226},
	{530, 230},
	{540, 234},
	{550, 238},
	{560, 243},
	{570, 247},
	{580, 251},
	{590, 255},
	{600, 259},
	{610, 263},
	{620, 268},
	{630, 272},
	{640, 276},
	{650, 280},
	{660, 284},
	{670, 288},
	{680, 293},
	{690, 297},
	{700, 301},
	{710, 305},
	{720, 309},
	{730, 313},
	{740, 317},
	{750, 322},
	{760, 326},
	{770, 330},
	{780, 334},
	{790, 338},
	{800, 342},
	{810, 346},
	{820, 351},
	{830, 355},
	{840, 359},
	{850, 363},
	{860, 367},
	{870, 371},
	{880, 375},
	{890, 380},
	{900, 384},
	{910, 388},
	{920, 392},
	{930, 396},
	{940, 400},
	{950, 404},
	{960, 408},
	{970, 413},
	{980, 417},
	{990, 421},
}

// For n < 5: no penalty (CriticalMisses = n) due to insufficient statistical power.
var criticalValueTableP050 = []Threshold{
	{2, 2},
	{3, 3},
	{4, 4},
	{5, 4},
	{6, 5},
	{7, 5},
	{8, 6},
	{9, 6},
	{10, 7},
	{20, 13},
	{30, 19},
	{40, 25},
	{50, 30},
	{60, 36},
	{70, 41},
	{80, 47},
	{90, 52},
	{100, 58},
	{110, 63},
	{120, 69},
	{130, 74},
	{140, 79},
	{150, 85},
	{160, 90},
	{170, 95},
	{180, 101},
	{190, 106},
	{200, 111},
	{210, 116},
	{220, 122},
	{230, 127},
	{240, 132},
	{250, 138},
	{260, 143},
	{270, 148},
	{280, 153},
	{290, 159},
	{300, 164},
	{310, 169},
	{320, 174},
	{330, 179},
	{340, 185},
	{350, 190},
	{360, 195},
	{370, 200},
	{380, 206},
	{390, 211},
	{400, 216},
	{410, 221},
	{420, 226},
	{430, 232},
	{440, 237},
	{450, 242},
	{460, 247},
	{470, 252},
	{480, 258},
	{490, 263},
	{500, 268},
	{510, 273},
	{520, 278},
	{530, 283},
	{540, 289},
	{550, 294},
	{560, 299},
	{570, 304},
	{580, 309},
	{590, 314},
	{600, 320},
	{610, 325},
	{620, 330},
	{630, 335},
	{640, 340},
	{650, 345},
	{660, 351},
	{670, 356},
	{680, 361},
	{690, 366},
	{700, 371},
	{710, 376},
	{720, 382},
	{730, 387},
	{740, 392},
	{750, 397},
	{760, 402},
	{770, 407},
	{780, 412},
	{790, 418},
	{800, 423},
	{810, 428},
	{820, 433},
	{830, 438},
	{840, 443},
	{850, 448},
	{860, 454},
	{870, 459},
	{880, 464},
	{890, 469},
	{900, 474},
	{910, 479},
	{920, 484},
	{930, 490},
	{940, 495},
	{950, 500},
	{960, 505},
	{970, 510},
	{980, 515},
	{990, 520},
}

// criticalValueTables maps p0 permille to critical value tables.
var criticalValueTables = map[int][]Threshold{
	50:  criticalValueTableP005, // p0 = 0.05
	100: criticalValueTableP010, // p0 = 0.10
	200: criticalValueTableP020, // p0 = 0.20
	300: criticalValueTableP030, // p0 = 0.30
	400: criticalValueTableP040, // p0 = 0.40
	500: criticalValueTableP050, // p0 = 0.50
}

// p0Multipliers defines fallback threshold for n > maxTableN as (numerator, denominator).
var p0Multipliers = map[int][2]int{
	50:  {1, 20}, // nMissed * 20 <= nTotal * 1  (5%)
	100: {1, 10}, // nMissed * 10 <= nTotal * 1  (10%)
	200: {1, 5},  // nMissed * 5 <= nTotal * 1   (20%)
	300: {3, 10}, // nMissed * 10 <= nTotal * 3  (30%)
	400: {2, 5},  // nMissed * 5 <= nTotal * 2   (40%)
	500: {1, 2},  // nMissed * 2 <= nTotal * 1   (50%)
}

// decimalToPermille converts decimal p0 to permille, returns -1 if unsupported.
func decimalToPermille(p0 decimal.Decimal) int {
	permille := p0.Mul(decimal.NewFromInt(1000)).IntPart()
	if _, ok := criticalValueTables[int(permille)]; ok {
		return int(permille)
	}
	return -1
}

// MissedStatTestLookupWithP0 returns true if miss count is acceptable using pre-computed tables.
func MissedStatTestLookupWithP0(nMissed, nTotal, p0Permille int) (bool, error) {
	if nTotal == 0 {
		return true, nil
	}
	if nMissed < 0 || nTotal < 0 || nMissed > nTotal {
		return false, errors.New("invalid input: requires 0 <= nMissed <= nTotal and nTotal > 0")
	}

	table, ok := criticalValueTables[p0Permille]
	if !ok {
		return false, errors.New("unsupported p0 value")
	}

	if nTotal > maxTableN {
		multiplier, ok := p0Multipliers[p0Permille]
		if !ok {
			return false, errors.New("unsupported p0 value for large n")
		}
		return int64(nMissed)*int64(multiplier[1]) <= int64(nTotal)*int64(multiplier[0]), nil
	}

	idx := sort.Search(len(table), func(i int) bool {
		return table[i].Total > nTotal
	})

	if idx == 0 {
		return true, nil
	}

	criticalValue := table[idx-1].CriticalMisses
	return nMissed <= criticalValue, nil
}
